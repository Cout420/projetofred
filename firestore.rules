/**
 * This ruleset enforces a strict role-based access control (RBAC) model centered
 * around a single 'admin' role. All data collections are considered administrative
 * content and are fully locked down by default.
 *
 * Core Philosophy:
 * Access is granted based on the existence of a document in the `/roles_admin`
 * collection, which serves as a database-managed list of administrators. This
 * approach (Database-Based Access Control or DBAC) avoids the need for custom
 * claims and allows for dynamic role management without re-deploying tokens.
 *
 * Data Structure:
 * - /testimonials/{testimonialId}: Content managed by admins.
 * - /services/{serviceId}: Content managed by admins.
 * - /contactFormEntries/{contactFormEntryId}: Content managed by admins.
 * - /imageGalleryItems/{imageGalleryItemId}: Content managed by admins.
 * - /roles_admin/{userId}: A special collection where the existence of a document
 *   at a path matching a user's UID grants them admin privileges.
 *
 * Key Security Decisions:
 * - Admin-Only Access: All content collections (`testimonials`, `services`, etc.)
 *   can only be read or written to by authenticated users with the 'admin' role.
 * - No Public Access: There is no publicly readable or writable data. All access
 *   requires a user to be a designated admin.
 * - Immutable Roles Collection: The `/roles_admin` collection is read-only within
 *   these rules. This is a critical security measure to prevent a compromised
 *   admin account from escalating privileges for other users. Admin roles must
 *   be managed out-of-band (e.g., via the Firebase Console or an Admin SDK).
 * - No Schema Validation: In line with the prototyping philosophy, these rules
 *   strictly enforce authorization (who can access what) but do not validate the
 *   shape or data types of the documents being written. This allows for flexible
 *   and rapid development on the frontend.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the user has an admin role by verifying the existence of a
     * corresponding document in the roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // --------------------------------
    // Collection Rules
    // --------------------------------

    /**
     * @description Manages testimonials. Only admins can read, create, update, or delete testimonials.
     * @path /testimonials/{testimonialId}
     * @allow (get) An admin user reads a single testimonial document.
     * @deny (list) A non-admin or unauthenticated user tries to list testimonials.
     * @principle Enforces a strict role-based access control for all operations.
     */
    match /testimonials/{testimonialId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages services. Only admins can read, create, update, or delete services.
     * @path /services/{serviceId}
     * @allow (create) An admin user adds a new service document.
     * @deny (update) A non-admin user tries to modify an existing service.
     * @principle Enforces a strict role-based access control for all operations.
     */
    match /services/{serviceId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages contact form submissions. Only admins can read or delete submissions.
     * @path /contactFormEntries/{contactFormEntryId}
     * @allow (list) An admin user lists all contact form submissions.
     * @deny (get) An unauthenticated user tries to read a specific submission.
     * @principle Enforces a strict role-based access control for all operations.
     */
    match /contactFormEntries/{contactFormEntryId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages image gallery items. Only admins can read, create, update, or delete gallery items.
     * @path /imageGalleryItems/{imageGalleryItemId}
     * @allow (delete) An admin user removes an image from the gallery.
     * @deny (create) A signed-in, non-admin user tries to add a new image.
     * @principle Enforces a strict role-based access control for all operations.
     */
    match /imageGalleryItems/{imageGalleryItemId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Defines which users are administrators. The existence of a document grants admin privileges.
     * This collection is read-only to prevent privilege escalation from a compromised client.
     * @path /roles_admin/{userId}
     * @allow (get) An admin user checks if another user ID has admin privileges.
     * @deny (create) An admin user tries to grant admin privileges to another user.
     * @principle Prevents privilege escalation by making the roles collection immutable from the client.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
/**
 * Core Philosophy: This ruleset implements a Role-Based Access Control (RBAC) model.
 * Public content is readable by anyone, while all write operations (create, update, delete)
 * and access to sensitive data are restricted to users with an 'admin' role.
 *
 * Data Structure: The data is organized into flat, top-level collections.
 * - Public content collections: /testimonials, /services, /image_gallery
 * - Private data collection: /contact_form_submissions
 * - Authorization collection: /roles_admin
 *
 * Key Security Decisions:
 * - Admin status is determined by the existence of a document in the /roles_admin/{userId}
 *   collection. This is a highly performant and secure way to manage roles.
 * - Contact form submissions are write-only for the public. Anyone can create a submission,
 *   but only admins can read, update, or delete them.
 * - The admin role collection (/roles_admin) is locked down, ensuring that only
 *   existing admins can grant or revoke admin privileges to other users.
 *
 * Denormalization for Authorization: The /roles_admin collection is the canonical example of
 * denormalization for authorization. Instead of checking a field on a user profile, we perform
 * a fast `exists()` check on a dedicated collection, which simplifies every admin-gated rule.
 *
 * Structural Segregation: Public collections (e.g., /services) are structurally separate
 * from private ones (e.g., /contact_form_submissions). This allows for safe and efficient
 * public list queries without risk of exposing private data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    // --------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has an admin role.
     * Admin status is granted by the existence of a document in the /roles_admin collection
     * where the document ID is the user's UID.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Publicly readable testimonials. Only admins can manage entries.
     * @path /testimonials/{testimonialId}
     * @allow (get) Any user, signed in or not, can read a single testimonial.
     * @deny (create) A signed-in, non-admin user cannot create a testimonial.
     * @principle Public read access with centralized admin control for content management.
     */
    match /testimonials/{testimonialId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores contact form submissions. Anyone can submit a message.
     *              Only admins are allowed to read or manage these submissions.
     * @path /contact_form_submissions/{submissionId}
     * @allow (create) Any user, including anonymous ones, can submit the contact form.
     * @deny (get) A non-admin user cannot read someone else's submission.
     * @principle Implements a secure "write-only" dropbox for public submissions, protecting user privacy.
     */
    match /contact_form_submissions/{submissionId} {
      allow get, list: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Publicly readable service offerings. Only admins can manage entries.
     * @path /services/{serviceId}
     * @allow (list) Any user, signed in or not, can list all available services.
     * @deny (update) A signed-in, non-admin user cannot modify a service description.
     * @principle Public read access with centralized admin control for content management.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Publicly viewable image gallery. Only admins can manage images.
     * @path /image_gallery/{galleryItemId}
     * @allow (get) Any user, signed in or not, can view a gallery image.
     * @deny (delete) A signed-in, non-admin user cannot delete a gallery image.
     * @principle Public read access with centralized admin control for content management.
     */
    match /image_gallery/{galleryItemId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages admin roles for the application. The existence of a document
     *              here grants a user admin privileges across the entire database.
     * @path /roles_admin/{userId}
     * @allow (create) An existing admin can create a new document to grant another user admin rights.
     * @deny (delete) A non-admin user cannot delete a document to revoke their own or someone else's admin rights.
     * @principle Secures the role management system itself, preventing privilege escalation.
     */
    match /roles_admin/{userId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }
  }
}